# docker-compose.yml (FINAL CORRECTED VERSION)

version: "3.8"

services:

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: meeting_api_server
    command: "uvicorn app.main:app --host 0.0.0.0 --port 8072 --reload"
    ports:
      - "8072:8072"
    volumes:
      - ./app:/code/app
      - ./shared_audio:/code/shared_audio
    env_file: .env
    restart: unless-stopped

  # -------------------------------------------------------------
  #  GPU Worker: Executes heavy AI tasks
  # -------------------------------------------------------------
  worker-gpu:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: meeting_gpu_worker
    command: >
      celery -A app.worker.celery_app worker -l info 
      --pool=solo 
      -Q gpu_tasks 
      --concurrency=1
    volumes:
      - ./app:/code/app
      - ./shared_audio:/code/shared_audio
      
      # --- THE FIX IS HERE ---
      # REMOVE the old, incorrect line:
      # - /usr/local/cuda/lib64:/usr/local/cuda/lib64
      
      # ADD the NEW, CORRECT line based on your 'find' command output.
      # This mounts the standard system library path where your NVIDIA driver has placed the cuDNN files.
      - /usr/lib/x86_64-linux-gnu:/usr/local/cuda/lib64
      # --- END OF FIX ---
      
    env_file: .env
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # -------------------------------------------------------------
  #  CPU Worker
  # -------------------------------------------------------------
  worker-cpu:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: meeting_cpu_worker
    command: >
      celery -A app.worker.celery_app worker -l info 
      -Q cpu_tasks 
      --concurrency=4
    volumes:
      - ./app:/code/app
      - ./shared_audio:/code/shared_audio
    env_file: .env
    restart: unless-stopped

# --- CLEANUP ---
# This top-level key is no longer needed because we are not using a
# Docker-managed named volume called 'shared_audio_files'. We are using
# a bind mount './shared_audio' directly.
# volumes:
#   shared_audio_files:
#     driver: local
